---
title: "county_collectivism_calculation"
output: html_document
author: "Erin Wang"
date: "2024-04-08"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Combine new American Community Survey 2022 to 2016 voting data
```{r, echo=FALSE}
setwd("/Users/erin/Desktop/county_collectivism")

prev <- read.csv("/Users/erin/Desktop/county_collectivism/previous_data/ICscoreall.csv")

prev_clean <- prev %>% 
  select(2, 3, 9, 11, 19) %>% 
  rename("prev_score" = "score",
         "libertarian_vote16" = "voting.for.libertarian")

acs_new <- read.csv("/Users/erin/Desktop/county_collectivism/American Community Survey 5-year/ACS22_5year_county.csv") #American Community Survey

merged <- acs_new %>% 
  left_join(prev_clean, by = c("county_fips" = "county.fips")) %>% 
  mutate(county_name = str_remove(county_name, "\\s+County$")) %>% 
  select(1, 10, 3:9, 12:13)

```


#Religious Affiliation
```{r, echo=FALSE}
religion <- read.csv("/Users/erin/Desktop/county_collectivism/religion/adherence_rate_county.csv")
head(religion)

religion$county_fips <- gsub("^0+", "", religion$county_fips)
religion <- religion %>%
  mutate(county_fips = as.integer(county_fips))

```

#Combine 
```{r, echo=FALSE}
mergedfinal <- merged %>% 
  left_join(religion, by = "county_fips") %>% 
  select(1:10, 12, 11)
head(mergedfinal)

write.csv(mergedfinal, "county_index.csv")

```



#Scaling and Standardization
Reverse coded items:
1. people living alone
2. elders living alone
3. divorce to marriage ratio
4. vote for libertarian
5. self-employed

notes: living with grandchildren, religion affiliation, and carpooling are not reverse coded

After reverse coding, these items are summed as an overall collectivism score. I linear transformed the collectivism score, so that the score is from 0 to 100. The standardized alpha is 0.68.

```{r, echo=FALSE}
mergedfinal <- read.csv("/Users/erin/Desktop/county_collectivism/county_index.csv")
mergedfinal <- mergedfinal[,-1]
#mergedfinal <- mergedfinal %>% 
  #filter(state != "District of Columbia")

colnames(mergedfinal)

#people living alone
mergedfinal$living_alone_reverse <- 1 - mergedfinal$living_alone
#elders living alone
mergedfinal$living_alone_65over_reverse <- 1 - mergedfinal$living_alone_65over
#living with grandchildren - not reversed
#divorce to marriage ratio
mergedfinal$divorce_marriage_reverse <- 1 / mergedfinal$divorce_marriage
#religion affiliation - not reversed
#vote for libertarian
mergedfinal$libertarian_vote16_reverse <- 1 - mergedfinal$libertarian_vote16
#carpooling - not reversed
#self-employed
mergedfinal$self_employed_reverse <- 1 - mergedfinal$self_employed

mergedfinal_short <- mergedfinal %>% 
  select(county_fips, living_alone_reverse, living_alone_65over_reverse, living_grandchildren, 
         divorce_marriage_reverse, religious_adherents, libertarian_vote16_reverse,
         carpool_drive_alone, self_employed_reverse) 

#check na in each column
sum(is.na(mergedfinal_short$living_alone_reverse)) #0
sum(is.na(mergedfinal_short$living_alone_65over_reverse)) #0
sum(is.na(mergedfinal_short$living_grandchildren)) #0
sum(is.na(mergedfinal_short$divorce_marriage_reverse)) #0
sum(is.na(mergedfinal_short$religious_adherents)) #0
sum(is.na(mergedfinal_short$libertarian_vote16_reverse)) #missing 474 counties
sum(is.na(mergedfinal_short$carpool_drive_alone)) #0
sum(is.na(mergedfinal_short$self_employed_reverse)) #0

#scale
data_cleaned <- mergedfinal_short %>% 
  mutate_at(vars(2:9), scale) %>% 
  rename_with(~ paste0(., "_z"), 2:9) %>%
  mutate(county_collectivism_raw = rowSums(select(., 2:9))) %>% 
  na.omit()

#linear transformation to scale the scores from 0 to 100
score_range <- range(data_cleaned$county_collectivism_raw)
data_cleaned$county_collectivism_score <- ((data_cleaned$county_collectivism_raw - score_range[1]) / (score_range[2] - score_range[1])) * 100

data_scoreonly <- data_cleaned %>% 
  select(county_fips, county_collectivism_raw, county_collectivism_score)

data_all <- merge(mergedfinal, data_scoreonly, by = "county_fips")

write.csv(data_all, "/Users/erin/Desktop/county_collectivism/county_collectivism_score_all.csv")

#compare the new score to prev score: r = 0.795, t = 50.944, df = 1514, p-value < 2.2e-16
cor.test(data_all$prev_score, data_all$county_collectivism_raw)

```


#Descriptives
```{r, echo=FALSE}
#collectivism score distribution
hist(data_all$county_collectivism_score,
     main = "County Collectivism Score Distribution",
     xlab = "Collectivism Score",
     ylim = c(0, 1250), 
     xlim = c(0, 100))


#Cronbach's alpha: standardized alpha = 0.61
library(psych)

alpha <- alpha(data_all[, c("living_alone_reverse", "living_alone_65over_reverse", 
                            "living_grandchildren", "divorce_marriage_reverse",
                            "religious_adherents", "libertarian_vote16_reverse", 
                            "carpool_drive_alone", "self_employed_reverse")], 
               keys = c(1, 1, 1, 1, 1, 1, 1, 1))
alpha


#correlation matrix
corrdata <- data_all %>% 
    select(4:11, 19) %>% 
    rename("living alone" = "living_alone",
           "elderly people living alone" = "living_alone_65over",
           "living with grandchildren" = "living_grandchildren",
           "divorce to marriage ratio" = "divorce_marriage",
           "with religious affiliation" = "religious_adherents",
           "voting Libertarian 2016" = "libertarian_vote16",
           "carpooling to drive alone" = "carpool_drive_alone",
           "self-employed workers" = "self_employed",
           "county collectivism score" = "county_collectivism_score")

library(Hmisc)
res2 <- rcorr(as.matrix(corrdata))
res2
  
res2$P[is.na(res2$P)] <- 1
  
library(corrplot)
corrplot(res2$r, type="upper", order="hclust", method="color",
           p.mat = res2$P, sig.level = 0.05, insig = "pch", pch.cex = 2, pch = 4,
           addCoef.col = "black", number.cex = 0.6,
           tl.col = "black",tl.srt = 45,tl.cex = 0.8, 
           diag = FALSE)


```



#Combine state and county
```{r, echo=FALSE}
county_score <- read.csv("/Users/erin/Desktop/county_collectivism/county_collectivism_score_all.csv")

county_score <- county_score %>% 
  select(county_fips, state, county_name, county_collectivism_score)

#get an averaged state score
county_score_group <- county_score %>% 
  group_by(state) %>% 
  summarise(avg_county_collectivism_score = mean(county_collectivism_score, na.rm = TRUE))

#merge three scores together
score_all <- county_score_group %>% 
  left_join(county_score, by = "state") %>% 
  select(3, 1, 4, 2, 5)
  
write.csv(score_all, "/Users/erin/Desktop/county_collectivism/score_all.csv")

```



 